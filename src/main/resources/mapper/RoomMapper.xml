<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.start01.dao.RoomDao">

    <select id="RoomAll" resultType="RoomDto">
        SELECT * FROM room
    </select>

    <select id="RoomSelectRecruit" resultType="RoomDto">
        SELECT * FROM room WHERE status = '모집중'
    </select>

    <select id="SelectById" parameterType="int" resultType="RoomDto">
        SELECT * FROM room WHERE store_id=#{storeId} AND status = '모집중'
    </select>

    <select id="RoomsWithJoinCount" resultType="com.example.start01.dto.RoomDto">
        SELECT r.id, r.store_id, r.room_name, r.room_address, r.max_people,
        COUNT(rj.id) AS joinCount
        FROM room r
        LEFT JOIN room_join rj ON r.id = rj.room_id
        WHERE r.status = '모집중'
        GROUP BY r.id, r.store_id, r.room_name, r.room_address, r.max_people
    </select>

    <select id="AllRoomSelect" resultType="RoomDto">
        SELECT
        r.id, r.store_id, r.room_name, r.room_address, r.max_people, r.status, r.created_at, r.room_address_detail,
        NVL(COUNT(rj.id), 0) AS join_count FROM room r
        LEFT JOIN room_join rj ON r.id = rj.room_id
        AND rj.status = '참여중'  <!-- 필요시 상태 조건 -->
        WHERE r.status = '모집중'
        GROUP BY r.id, r.store_id, r.room_name, r.room_address, r.max_people, r.status, r.created_at, r.room_address_detail
        ORDER BY r.created_at DESC
    </select>

    <select id="SelectByIdOnly" parameterType="int" resultType="RoomDto">
        SELECT * FROM room WHERE id=#{storeId}
    </select>

    <!-- 룸/챗 -->
    <select id="selectRoom" parameterType="RoomDto" resultType="RoomDto">
        SELECT
        id,
        store_id,
        room_name,
        room_address,
        room_address_detail,
        max_people,
        users,
        leader_id,
        status,
        created_at,
        join_count
        FROM room
        <where>
            <if test="id != null">AND id = #{id}</if>
            <if test="storeId != null">AND store_id = #{storeId}</if>
            <if test="roomName != null">AND room_name = #{roomName}</if>
            <if test="roomNameLike != null">AND room_name LIKE CONCAT('%', #{roomNameLike}, '%')</if>
            <if test="roomAddress != null">AND room_address = #{roomAddress}</if>
            <if test="roomAddressDetail != null">AND room_address_detail = #{roomAddressDetail}</if>
            <if test="maxPeople != null">AND max_people = #{maxPeople}</if>
            <if test="leaderId != null">AND leader_id = #{leaderId}</if>
            <if test="status != null">AND status = #{status}</if>
        </where>
    </select>
    <select id="selectAllRoom" parameterType="RoomDto" resultType="RoomDto">
        SELECT * FROM room where id = #{id}
    </select>
    <select id="selectReadyPeople" parameterType="map" resultType="Integer">
        SELECT ready_people from room WHERE id = #{roomId}
    </select>
    <update id="updateRoomUsers" parameterType="RoomDto">
        UPDATE room
        SET users = #{users, jdbcType=VARCHAR}
        WHERE id = #{id}
    </update>
    <update id="updateReadyCount" parameterType="map" >
        UPDATE room
        SET ready_people = ready_people + #{delta}
        WHERE id = #{roomId}
    </update>
</mapper>