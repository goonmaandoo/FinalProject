<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.start01.dao.RoomDao">

    <select id="RoomAll" resultType="com.example.start01.dto.RoomDto">
        SELECT * FROM room
    </select>

    <select id="RoomSelectRecruit" resultType="com.example.start01.dto.RoomDto">
        SELECT * FROM room WHERE status = '모집중'
    </select>

    <select id="SelectById" parameterType="int" resultType="com.example.start01.dto.RoomDto">
        SELECT * FROM room WHERE store_id=#{storeId} AND status = '모집중'
    </select>

    <select id="RoomsWithJoinCount" resultType="com.example.start01.dto.RoomDto">
        SELECT r.id, r.store_id, r.room_name, r.room_address, r.max_people,
        COUNT(rj.id) AS joinCount
        FROM room r
        LEFT JOIN room_join rj ON r.id = rj.room_id
        WHERE r.status = '모집중'
        GROUP BY r.id, r.store_id, r.room_name, r.room_address, r.max_people
    </select>

    <select id="AllRoomSelect" resultType="com.example.start01.dto.RoomDto">
        SELECT
        r.id, r.store_id, r.room_name, r.room_address, r.max_people, r.status, r.created_at, r.room_address_detail,
        NVL(COUNT(rj.id), 0) AS joinCount
        FROM room r
        LEFT JOIN room_join rj ON r.id = rj.room_id AND rj.status = '참여중'
        WHERE r.status = '모집중'
        GROUP BY r.id, r.store_id, r.room_name, r.room_address, r.max_people, r.status, r.created_at, r.room_address_detail
        ORDER BY r.created_at DESC
    </select>

    <select id="SelectByIdOnly" parameterType="int" resultType="com.example.start01.dto.RoomDto">
        SELECT * FROM room WHERE id=#{id}
    </select>

    <insert id="RoomInsert" parameterType="com.example.start01.dto.RoomDto" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO room (
        store_id,
        room_name,
        room_address,
        max_people,
        users,
        leader_id,
        status,
        room_address_detail,
        created_at
        ) VALUES (
        #{storeId},
        #{roomName},
        #{roomAddress},
        #{maxPeople},
        #{users},
        #{leaderId},
        #{status},
        #{roomAddressDetail},
        SYSDATE
        )
    </insert>

</mapper>
